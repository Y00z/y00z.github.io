---
layout: post
title: 制作BadUSB
date: 2017-05-12 15:14:09
comments: true
tags:
	- 安全攻防
---


### 前言
><font color="#ff0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**文中提及的部分技术，可能带有一定攻击性，仅供安全学习和教学用途，禁止非法使用！**</font>


### 正文
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BadUSB早在2014年底的PacSec会议上便已经提出，这是USB协议中的一个漏洞————USB设备可以伪装成为其他任何设备，例如输入设备、网卡等等。这个漏洞目前还没有得到修复，几乎可以说在有合适的脚本的情况下，只要能够插进去，没有什么是黑不掉的！<!--more-->

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;差不多的原理就是伪装成HID设备如键盘或者鼠标，然后模拟键盘按键来打开cmd执行powershell指令对电脑进行攻击，而且这种攻击是无法拦截的。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;制作BadUsb有两个方法，一种是Arduino开发板，另一种PS2251-03的微处理器的U盘，可以在这里看U盘的[列表型号](https://github.com/brandonlw/Psychson/wiki/Known-Supported-Devices) ，这里我使用的第一种制作方法。
(ps：我本来用的是第二种方法，买了指定型号的u盘，买回来后发现微处理器并不是PS2251-03微处理器，然后才换了第一种方法)


#### 材料

	 * Arduino Leonardo
	 * Arduino IDE 
	 * micro usb数据线

Arduino Leonardo 可以去水深宝淘到。

Arduino IDE 下载地址：[https://www.arduino.cc/en/Main/Software](https://www.arduino.cc/en/Main/Software)

Arduino Leonardo **↓**

 ![](/images/pasted-123.jpg)

拆开看看 **↓**

![](/images/pasted-124.jpg)

使用micro usb 安卓数据线就可以和电脑连接了  **↓**

![](/images/pasted-125.jpg)

##### Arduino IDE

打开后默认是这样的  **↓**

![](/images/pasted-126.jpg)

同时需要把IDE菜单=>工具的两个选项选一下。 **↓**

![](/images/pasted-127.jpg)


这个选项需要电脑连接开发板后才有  **↓**

![](/images/pasted-128.jpg)

然后可以来编写代码了。 
我们可以先来写一个hello world  **↓**

```c
#include<Keyboard.h> //包含键盘模块头文件
void setup() {
  // put your setup code here, to run once:
  Keyboard.begin();//开始键盘通信
  delay(1000);//延时1000毫秒，不要太短，因为每天电脑的运行速度都不一样
  Keyboard.press(KEY_CAPS_LOCK); //按下大写键 这里我们最好这样写 不然大多数电脑在中文输入的情况下就会出现问题
  Keyboard.release(KEY_CAPS_LOCK); //释放大写键
  delay(500);
  Keyboard.press(KEY_LEFT_GUI);//按下徽标键 也就是win键
  delay(500);
  Keyboard.press('r');//按下r键
  delay(500);
  Keyboard.release(KEY_LEFT_GUI);//松掉win键
  Keyboard.release('r');//松掉r键
  delay(500);
  Keyboard.println("cmd");//输入cmd进入DOS
  delay(500);
  Keyboard.press(KEY_RETURN);  //按下回车键
  Keyboard.release(KEY_RETURN); //释放回车键
  delay(500);
  Keyboard.println("echo hello world");
  Keyboard.press(KEY_RETURN);  //按下回车键
  Keyboard.release(KEY_RETURN); //释放回车键
  delay(500);
  Keyboard.press(KEY_CAPS_LOCK); //按下大写键
  Keyboard.release(KEY_CAPS_LOCK); //释放大写键 我们再次关闭开启的大写键
  delay(500);
  Keyboard.end();//结束键盘通讯
}

void loop() {
  // put your main code here, to run repeatedly:
}

```

然后编译验证  **↓**

![](/images/pasted-129.jpg)

如果提示这个就说明编译验证成功了  **↓**

![](/images/pasted-130.jpg)

接下来就可以把代码上传到Arduino Leonardo，来完成BadUSB制作的最后一步。  **↓**

![](/images/pasted-131.jpg)

上传成功后会自动断开USB然后再次连接并且执行代码。

会根据代码来依次执行，先按出win+r键，然后按出cmd 回车，最后输入echo hello world。

### 总结

当然我们可以执行powershell指令来下载自己的payload然后执行，或者其他一些代码。

我这里放几个例子[https://github.com/Y00z/BadUSB](https://github.com/Y00z/BadUSB)。



